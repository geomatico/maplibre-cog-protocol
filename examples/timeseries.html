<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maplibre COG Protocol Example</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <script src="dist/index.js"></script>
  <style>
      html, body, #map {
          margin: 0;
          width: 100%;
          height: 100%;
      }

      #info {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          background: #2d2d2d;
          border: 1px solid #bbbbbb;
          color: #bbbbbb;
          padding: 6px;
          border-radius: 5px;
          font-family: monospace;
          font-size: 18px;
      }
  </style>
</head>
<body>
<div id="map"></div>
<div id="info"></div>
<script type="module">
  let map = new maplibregl.Map({
    container: 'map',
    style: 'https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json',
    center: [1.5462, 41.1873],
    zoom: 16,
    hash: true
  });

  const url = "./data/timeseries.tif";

  const colorScale = MaplibreCOGProtocol.colorScale({colorScheme: 'BrewerRdYlBu10', min: 1, max: 7, isContinuous: true, isReverse: true});

  const showBand = i => MaplibreCOGProtocol.setColorFunction(url, (pixel, color) => {
    const value = pixel[i];
    if (value === -9999) {
      color[0] = color[1] = color[2] = color[3] = 0;
    } else {
      const [r, g, b] = colorScale(value);
      color[0] = r;
      color[1] = g;
      color[2] = b;
      color[3] = 255;
    }
  });

  let b = 0;
  let t = performance.now();
  setInterval(() => {
    console.log('Animation took', performance.now() - t, ' ms');
    t = performance.now();
    b = b + 10;
    if(b > 100) b = 0;
    showBand(b);
    if (map.getLayer('imageLayer')) {
      map.removeLayer('imageLayer');
      map.addLayer({
        source: 'imageSource',
        id: 'imageLayer',
        type: 'raster'
      });
    }
  }, 500);

  maplibregl.addProtocol('cog', MaplibreCOGProtocol.cogProtocol);

  map.on('load', () => {
    map.addSource('imageSource', {
      type: 'raster',
      url: `cog://${url}`,
      tileSize: 256
    });

    map.addLayer({
      source: 'imageSource',
      id: 'imageLayer',
      type: 'raster'
    });
  });

  map.on('drag', () => document.getElementById('info').style.display = 'none');

  map.on('mousemove', (e) => {
    const {lngLat: {lat: latitude, lng: longitude}, point: {x, y}} = e;
    const zoom = map.getZoom();

    document.getElementById('info').style.left = x + 10 + 'px';
    document.getElementById('info').style.top = y + 20 + 'px';

    MaplibreCOGProtocol.locationValues(url, {latitude, longitude}, zoom)
      .then(pixel => {
        if (isNaN(pixel[b])) {
          map.getCanvas().style.cursor = '';
          document.getElementById('info').style.display = 'none';
        } else {
          map.getCanvas().style.cursor = 'default';
          document.getElementById('info').style.display = 'block';
          document.getElementById('info').innerHTML = `Value: <b>${Math.round(pixel[b] * 100)/100}</b>`;
        }
      });
  });

</script>
</body>
</html>
